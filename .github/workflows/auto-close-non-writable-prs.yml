name: close-pr-from-non-writers

on:
  pull_request_target:
    types: [opened, reopened]

# PR を閉じるために pull-requests: write が必要
permissions:
  pull-requests: write

jobs:
  check-permission-and-close:
    runs-on: ubuntu-latest

    steps:
      - name: Generate token from GitHub App
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.AUTO_CLOSE_APP_ID }}
          private-key: ${{ secrets.AUTO_CLOSE_PRIVATE_KEY }}

      - name: Get permission of PR author
        id: perm
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const user = context.payload.pull_request.user.login;
            const { owner, repo } = context.repo;

            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner,
              repo,
              username: user,
            });

            core.info(`permission of ${user}: ${data.permission}`);
            core.setOutput("permission", data.permission);

      - name: Close PR if author does not have write access
        if: |
          steps.perm.outputs.permission != 'write' &&
          steps.perm.outputs.permission != 'maintain' &&
          steps.perm.outputs.permission != 'admin'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const pullRequestId = context.payload.pull_request.node_id;

            // Use GraphQL mutation to close PR with comment in a single operation
            const mutation = `
              mutation($pullRequestId: ID!, $comment: String!) {
                closePullRequest(input: {pullRequestId: $pullRequestId}) {
                  pullRequest {
                    id
                    closed
                  }
                }
                addComment(input: {subjectId: $pullRequestId, body: $comment}) {
                  commentEdge {
                    node {
                      id
                    }
                  }
                }
              }
            `;

            await github.graphql(mutation, {
              pullRequestId: pullRequestId,
              comment: 'This repository accepts pull requests only from collaborators with write access.',
            });
