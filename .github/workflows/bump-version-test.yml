name: Bump version (test)

# バージョンタグ付けワークフローの簡易版
# 依存関係や機密情報を削除し、バージョンタグ付け機能のみを動作確認できるようにしたもの
#
# This is a simplified version of the version tagging workflow
# for testing purposes, without dependencies and confidential information.
# Removed: SSH keys, AWS credentials, ECR, Docker image building
# Kept: Version tagging logic using mathieudutour/github-tag-action@v6.2
on:
  push:
    branches:
      - develop
  workflow_dispatch:  # Allow manual triggering for testing

permissions:
  contents: write

jobs:
  # First job: dry-run to test what tag would be created
  dry-run-tag:
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Bump version and push tag (dry-run)
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          append_to_pre_release_tag: rc
          dry_run: true
      
      - name: Display dry-run results
        run: |
          echo "New tag would be: ${{ steps.tag_version.outputs.new_tag }}"
          echo "Changelog:"
          echo "${{ steps.tag_version.outputs.changelog }}"

  # Second job: actually create the tag and release
  # This depends on dry-run-tag to ensure we see what would happen first
  # Note: We must run github-tag-action again (not in dry-run mode) to actually create the tag
  # The dry-run job only previews; it doesn't create anything
  create-release:
    runs-on: ubuntu-latest
    needs: dry-run-tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          append_to_pre_release_tag: rc
      
      - name: Create a GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
