name: pr-care-on-creation

on:
  pull_request_target:
    types: [opened, reopened]

# PR を閉じる・assignee を設定するために pull-requests: write が必要
permissions:
  pull-requests: write

jobs:
  check-permission-and-close:
    runs-on: ubuntu-latest

    steps:
      - name: Get permission of PR author
        id: perm
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const user = context.payload.pull_request.user.login;
            const userType = context.payload.pull_request.user.type;
            const { owner, repo } = context.repo;

            // Accept all bot accounts without checking permissions
            // (simplified approach; all bots are allowed)
            if (userType === 'Bot') {
              core.info(`${user} is a bot - allowing PR`);
              core.setOutput("permission", "admin");
              return;
            }

            const { data } =
              await github.rest.repos.getCollaboratorPermissionLevel({
              owner,
              repo,
              username: user,
            });

            core.info(`permission of ${user}: ${data.permission}`);
            core.setOutput("permission", data.permission);

      - name: Close PR if author does not have write access
        if: |
          steps.perm.outputs.permission != 'write' &&
          steps.perm.outputs.permission != 'maintain' &&
          steps.perm.outputs.permission != 'admin'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const pullRequestId = context.payload.pull_request.node_id;

            // Use GraphQL mutation to close PR with comment
            // in a single operation
            const mutation = `
              mutation($pullRequestId: ID!, $comment: String!) {
                closePullRequest(input: {pullRequestId: $pullRequestId}) {
                  pullRequest {
                    id
                    closed
                  }
                }
                addComment(input: {subjectId: $pullRequestId, body: $comment}) {
                  commentEdge {
                    node {
                      id
                    }
                  }
                }
              }
            `;

            await github.graphql(mutation, {
              pullRequestId: pullRequestId,
              comment: >-
                This repository accepts pull requests only from
                collaborators with write access.
            });

      - name: Auto-assign PR author if no assignees
        if: |
          steps.perm.outputs.permission == 'write' ||
          steps.perm.outputs.permission == 'maintain' ||
          steps.perm.outputs.permission == 'admin'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pullRequestNumber = context.payload.pull_request.number;
            const pullRequestAuthor = context.payload.pull_request.user.login;
            const currentAssignees = context.payload.pull_request.assignees;

            core.info(
              `PR #${pullRequestNumber} - Author: ${pullRequestAuthor}`
            );
            core.info(`Current assignees count: ${currentAssignees.length}`);

            // assignee が空の場合のみ、PR 作成者を assignee として設定
            if (currentAssignees.length === 0) {
              core.info(
                `No assignees found. Assigning PR author: ${pullRequestAuthor}`
              );
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: pullRequestNumber,
                assignees: [pullRequestAuthor],
              });

              core.info(
                `Successfully assigned ${pullRequestAuthor} ` +
                `to PR #${pullRequestNumber}`
              );
            } else {
              core.info(
                'PR already has assignees. Skipping auto-assignment.'
              );
            }
